<!doctype html><html class=no-js lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta property="og:title" content="SpotBot Workshop"><meta property="og:type" content="website"><meta property="og:url" content><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=generator content="Hugo 0.80.0"><meta name=description content="My AWS Workshop"><meta name=author content="Jane Architect"><link rel="shortcut icon" href=https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico type=image/ico><link rel=icon href=https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico type=image/ico><title>pegasus模型实验 :: SpotBot Workshop</title><link href=../css/nucleus.css rel=stylesheet><link href=../css/fontawesome-all.min.css rel=stylesheet><link href=../css/hybrid.css rel=stylesheet><link href=../css/featherlight.min.css rel=stylesheet><link href=../css/perfect-scrollbar.min.css rel=stylesheet><link href=../css/auto-complete.css rel=stylesheet><link href=../css/atom-one-dark-reasonable.css rel=stylesheet><link href=../css/theme.css rel=stylesheet><link href=../css/hugo-theme.css rel=stylesheet><link href=../css/theme-aws.css rel=stylesheet><script src=../js/jquery-3.3.1.min.js></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style></head><body data-url=../04pegusas/0401prepare.html><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><div><a href=../ title="Go home"><img style=vertical-align:middle src=../images/logo.png height=70px></a></div></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=../js/lunr.min.js></script><script type=text/javascript src=../js/auto-complete.js></script><script type=text/javascript>var baseurl="";</script><script type=text/javascript src=../js/search.js></script></div><div class=highlightable><ul class=topics><li data-nav-id=/01introduction.html title="what is text summary" class=dd-item><a href=../01introduction.html><b>1.</b> what is text summary
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/01introduction/100algorithm.html title="1.1 算法概述" class=dd-item><a href=../01introduction/100algorithm.html>1.1 算法概述
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/01introduction/200data.html title="1.2 数据集" class=dd-item><a href=../01introduction/200data.html>1.2 数据集
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/01introduction/300metrics.html title="1.3 评估指标" class=dd-item><a href=../01introduction/300metrics.html>1.3 评估指标
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/02textrank.html title="基于Amazon SageMaker的TEXTRANK模型训练动手实验" class=dd-item><a href=../02textrank.html><b>2. </b>基于Amazon SageMaker的TEXTRANK模型训练动手实验
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/02textrank/0201overview.html title=环境准备 class=dd-item><a href=../02textrank/0201overview.html><b>2.0</b>环境准备
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/02textrank/0210component.html title=texkrank模型实验 class=dd-item><a href=../02textrank/0210component.html><b>2.1</b> texkrank模型实验
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/03bertseq2seq.html title="基于Amazon SageMaker的BERT-SEQ2SEQ模型训练动手实验" class=dd-item><a href=../03bertseq2seq.html><b>3. </b>基于Amazon SageMaker的BERT-SEQ2SEQ模型训练动手实验
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/03bertseq2seq/0301train.html title=bert-seq2seq模型实验 class=dd-item><a href=../03bertseq2seq/0301train.html><b>3.1</b> bert-seq2seq模型实验
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/04pegusas.html title="基于Amazon SageMaker的PEGUSAS模型部署动手实验" class="dd-item
parent"><a href=../04pegusas.html><b>4. </b>基于Amazon SageMaker的PEGUSAS模型部署动手实验
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/04pegusas/0401prepare.html title=pegasus模型实验 class="dd-item
parent
active"><a href=../04pegusas/0401prepare.html><b>3.1 </b>pegasus模型实验
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul><section id=prefooter><hr><ul><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i>Clear History</a></li></ul></section><section id=footer><left><h5 class=copyright>&copy; 2019 Amazon Web Services, Inc. or its Affiliates. All rights reserved.<h5></left></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fa fa-bars"></i></a></span><span class=links><a href=../>AWS Datalab- 文档摘要</a> > <a href=../04pegusas.html>基于Amazon SageMaker的PEGUSAS模型部署动手实验</a> > pegasus模型实验</span></div></div></div><div id=chapter><div id=body-inner><h1>pegasus模型实验</h1><p>##预训练任务</p><p>预训练任务模仿了PEGASUS的摘要式预训练。具体来说，假设一个文档有n个句子，我们从中挑出大约n/4个句子（可以不连续），使得这n/4个句子拼起来的文本，跟剩下的3n/4个句子拼起来的文本，最长公共子序列尽可能长，然后我们将3n/4个句子拼起来的文本视为原文，n/4个句子拼起来的文本视为摘要，通过这样的方式构成一个“(原文, 摘要)”的伪摘要数据对。</p><p>运行环境：tensorflow 1.15 + keras 2.3.1 + bert4keras 0.10.0</p><h2 id=模型下载>模型下载</h2><h1 id=quick-start>quick start</h1><h3 id=train>train</h3><p>将待训练的数据集放在<code>data</code>目录下</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/jackie930/t5-pegasus-textsummary.git
source activate tensorflow_p36
pip install tensorflow<span style=color:#f92672>==</span>1.15 keras<span style=color:#f92672>==</span>2.3.1 bert4keras<span style=color:#f92672>==</span>0.10.0 jieba tqdm rouge
python finetune.py
</code></pre></div><p>训练结束会产生一个keras结构的模型文件 - best_model.weights</p><h3 id=预测>预测</h3><p>下载模型文件，目录结构为</p><p>chinese_t5_pegasus_base/
best_model.weights</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>python test.py
</code></pre></div><h3 id=评估>评估</h3><p>运行 <code>python evaluatiion.py</code></p><p>得到结果 <code>{'rouge-1': 0.885041123153444, 'rouge-2': 0.8795828353099052, 'rouge-l': 0.9046418758557804, 'bleu': 0.8239310846742561}</code></p><h3 id=部署>部署</h3><pre><code>#make sure you got trained models 
sh build_and_push.sh
</code></pre><p>run on endpoint</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e>#sin</span>
endpoint_ecr_image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;847380964353.dkr.ecr.ap-southeast-1.amazonaws.com/pegasus&#34;</span>
<span style=color:#75715e>#ningxia</span>
<span style=color:#75715e>#endpoint_ecr_image=&#34;251885400447.dkr.ecr.cn-northwest-1.amazonaws.com.cn/pegasus&#34;</span>
python create_endpoint.py <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--endpoint_ecr_image_path <span style=color:#e6db74>${</span>endpoint_ecr_image<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--endpoint_name <span style=color:#e6db74>&#39;pegasus&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--instance_type <span style=color:#e6db74>&#34;ml.g4dn.2xlarge&#34;</span>
</code></pre></div><p>在部署结束后，看到SageMaker控制台生成了对应的endpoint,可以使用如下客户端代码测试调用</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> boto3.session <span style=color:#f92672>import</span> Session
<span style=color:#f92672>import</span> json
txt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;来源|零壹财经作者|任俊东12月1日，国家互联网信息办公室发布关于《常见类型移动互联网应用程序（App）必要个人信息范围》公开征求意见的通知。此次《意见稿》规定了支付、借贷、银行等38类常见类型App必要个人信息范围，明确App必要个人信息界限，不得因非必要信息拒绝用户安装使用。零壹财经自今年3月起开展了手机App评测工作，通过对金融、购物、视频等10大类300多款App评测发现，9成以上APP都存在违规收集信息问题，其中违反必要原则，收集与其业务无关的个人信息、用户拒绝同意就无法安装使用等问题最为严重。上月，全国App个人信息保护监管会召开。会上阿里、腾讯、字节等互联网巨头遭监管点名批评：在App个人信息保护工作方面，存在思想漠视、侥幸心理、技术对抗三类问题。1.对38类App必要个人信息范围向社会征求意见针对此次《意见稿》，国家网信办表示，近年来App广泛应用在促进经济社会发展、服务民生等方面发挥了重要作用。同时，App超范围收集、强制收集用户个人信息普遍存在，用户拒绝同意就无法安装使用。为落实《中华人民共和国网络安全法》关于个人信息收集合法、正当、必要的原则，规范App个人信息收集行为，因而明确常见App收集必要个人信息范围。意见反馈时间截止到2020年12月16日。2.12类App无须个人信息，即可使用基本功能服务根据《意见稿》，国家网信办拟规定网络直播、在线影音、短视频、新闻资讯、运动健身、浏览器、输入法、安全管理、电子图书、拍摄美化、应用商店、实用工具类共12类App无须个人信息，即可使用基本功能服务。3.零壹App评测：9成以上App存在违规收集信息问题为规范收集APP信息收集和使用、加强个人信息保护，切实维护收集APP消费者合法权益，并依据相关监管政策法规，零壹财经App评测中心于2020年3月2日启动App评测专项工作。中心相关评测工作得到了App消费者、监管部门、相关企业、行业从业者等多方的广泛关注和支持。通过对金融、购物、视频等10大类300多款App评测发现，9成以上APP都存在违规收集信息问题，其中违反必要原则，收集与其业务无关的个人信息、用户拒绝同意就无法安装使用等问题最为严重。4.阿里、腾讯、字节等遭监管点名批评，App个人信息保护进入新的发展阶段11月27日，全国App个人信息保护监管会在北京召开，工信部召集国内互联网行业的头部企业，总结过去半年来App个人信息保护专项整治行动的成果，部署下一阶段整治行动。工信部信息通信管理局副局长鲁春从在会上表示，工信部针对大企业的App进行了全覆盖检测，对阿里巴巴的40余款、字节跳动30余款，腾讯30余款、百度20余款、网易10余款、小米10余款用户下载量大、使用率高的App进行了重点检测，发现存在思想漠视、侥幸心理、技术对抗三类问题。互联网个人信息数据野蛮生长时代已成过去，APP个人信息保护正在迎来新的发展阶段。切实维护用户合法权益，严厉惩处互联网企业违法违规行为是今后互联网监管的常态。企业只有从思想上重视、行动上遵守，把用户的利益作为企业的核心关切，才能持续发展。添加作者微信：daodao0312，可获取《常见类型移动互联网应用程序（App）必要个人信息范围（征求意见稿）》，或您有App评测需求请联系作者。&#34;</span>
data<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;data&#34;</span>: txt}
session <span style=color:#f92672>=</span> Session()
    
runtime <span style=color:#f92672>=</span> session<span style=color:#f92672>.</span>client(<span style=color:#e6db74>&#34;runtime.sagemaker&#34;</span>)
response <span style=color:#f92672>=</span> runtime<span style=color:#f92672>.</span>invoke_endpoint(
    EndpointName<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;pegasus&#39;</span>,
    ContentType<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;application/json&#34;</span>,
    Body<span style=color:#f92672>=</span>json<span style=color:#f92672>.</span>dumps(data),
)

result <span style=color:#f92672>=</span> json<span style=color:#f92672>.</span>loads(response[<span style=color:#e6db74>&#34;Body&#34;</span>]<span style=color:#f92672>.</span>read())
<span style=color:#66d9ef>print</span> (result)
</code></pre></div><footer class=footline></footer></div></div></div><div id=navigation><a class="nav nav-prev" href=../04pegusas.html title="基于Amazon SageMaker的PEGUSAS模型部署动手实验"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=../01introduction.html title="what is text summary" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=../js/clipboard.min.js></script><script src=../js/perfect-scrollbar.min.js></script><script src=../js/perfect-scrollbar.jquery.min.js></script><script src=../js/jquery.sticky.js></script><script src=../js/featherlight.min.js></script><script src=../js/html5shiv-printshiv.min.js></script><script src=../js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script src=../js/modernizr.custom-3.6.0.js></script><script src=../js/learn.js></script><script src=../js/hugo-learn.js></script><link href=../mermaid/mermaid.css rel=stylesheet><script src=../mermaid/mermaid.js></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>